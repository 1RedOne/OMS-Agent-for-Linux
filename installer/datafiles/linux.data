%Variables
PF:		'Linux'


%OmiService_funcs
StopOmiServer() {
    if [ -x /usr/sbin/invoke-rc.d ]; then
        /usr/sbin/invoke-rc.d omiserverd stop
    elif [ -x /sbin/service ]; then
        service omiserverd stop
    else
        echo "Unrecognized Service Controller to start OMI Service" 1>&2
        exit 1
    fi
}

StartOmiServer() {
    if [ -x /usr/sbin/invoke-rc.d ]; then
        /usr/sbin/invoke-rc.d omiserverd start
    elif [ -x /sbin/service ]; then
        service omiserverd start
    else
        echo "Unrecognized Service Controller to start OMI Service" 1>&2
        exit 1
    fi
}

RestartOmiServer() {
    if [ $OMI_IS_RUNNING -eq 1 ]; then
        StopOmiServer
    fi
    StartOmiServer
}

%OMSService_funcs
StopOMSServer() {
    if [ -x /usr/sbin/invoke-rc.d ]; then
        /usr/sbin/invoke-rc.d omsagent stop
    elif [ -x /sbin/service ]; then
        service omsagent stop
    else
        echo "Unrecognized Service Controller to start omsagent Service" 1>&2
        exit 1
    fi
}

StartOMSServer() {
    if [ -x /usr/sbin/invoke-rc.d ]; then
        /usr/sbin/invoke-rc.d omsagent start
    elif [ -x /sbin/service ]; then
        service omsagent start
    else
        echo "Unrecognized Service Controller to start omsagent Service" 1>&2
        exit 1
    fi
}

RestartOMSServer() {
    # if [ $OMI_IS_RUNNING -eq 1 ]; then
        StopOMSServer
    # fi
    StartOMSServer
}

%Preinstall_1000
# Add the 'omsagent' service account if it does not already exist
egrep -q "^omsagent:" /etc/passwd
if [ $? -ne 0 ]; then
   echo "Creating omsagent service account ..."
   useradd -r -c "OMS agent" -d /var/opt/microsoft/omsagent/run -s /bin/bash omsagent
fi

%Postuninstall_1000
#include OmiService_funcs
#include CheckIfOmiIsRunning

# If we're called for upgrade, don't do anything
if ${{PERFORMING_UPGRADE_NOT}}; then
    # Restart the OMI server in case an agent is running under service account
    RestartOmiServer

    # Remove the service account
    echo "Deleting omsagent service account ..."
    userdel omsagent
fi
