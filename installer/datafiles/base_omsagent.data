%Variables
SHELL_HEADER:            '#!/bin/sh'
OMSHOME:                 '/opt/microsoft/omsagent'
SUDO_LOC:                '/etc/opt/microsoft/omsagent/conf/sudodir'
SUDO_DIR:                '/usr/bin'

SHORT_NAME:              'omsagent'
SHORT_NAME_PREFIX:       'MSFT'
LONG_NAME:               'Microsoft Operations Management Suite for UNIX/Linux agent'
GROUP:                   'Applications/System'
LICENSE:                 'none'
VENDOR:                  'http://www.microsoft.com'
PROVIDES:                'omsuploads'
DESCRIPTION:             'Provides agent for the Microsoft Operations Management Suite.'
MAINTAINER:              'Microsoft Corporation'

%Defines

%Files
/etc/opt/microsoft/omsagent/conf/fluent.conf;                           installer/conf/fluent.conf;                            644; omsagent; omsagent
/etc/opt/microsoft/omsagent/conf/installinfo.txt;                       installer/conf/installinfo.txt;                        644; omsagent; omsagent; conffile
/opt/microsoft/omsagent/fluent-plugin/in_omi.rb;                        source/code/plugins/in_omi.rb;                         744; omsagent; omsagent
/opt/microsoft/omsagent/fluent-plugin/Libomi.so;                        intermediate/${{BUILD_CONFIGURATION}}/Libomi.so;       744; omsagent; omsagent
/opt/microsoft/omsagent/bin/omsadmin.sh;                                source/code/maintenance/omsadmin.sh;                   744; omsagent; omsagent

%Links

%Directories
/opt;                                                   755; omsagent; omsagent; sysdir
/etc;                                                   755; omsagent; omsagent; sysdir
/etc/opt;                                               755; omsagent; omsagent; sysdir
/var;                                                   755; omsagent; omsagent; sysdir
/var/opt;                                               755; omsagent; omsagent; sysdir

/etc/opt/microsoft;                                     755; omsagent; omsagent
/etc/opt/microsoft/omsagent;                            755; omsagent; omsagent
/etc/opt/microsoft/omsagent/certs;                      755; omsagent; omsagent
/etc/opt/microsoft/omsagent/conf;                       755; omsagent; omsagent

/opt/microsoft;                                         755; omsagent; omsagent
/opt/microsoft/omsagent;                                755; omsagent; omsagent
/opt/microsoft/omsagent/bin;                            755; omsagent; omsagent
/opt/microsoft/omsagent/fluent-plugin;                  755; omsagent; omsagent

/var/opt/microsoft;                                     755; omsagent; omsagent
/var/opt/microsoft/omsagent;                            755; omsagent; omsagent
/var/opt/microsoft/omsagent/run;                        755; omsagent; omsagent
/var/opt/microsoft/omsagent/tmp;                        755; omsagent; omsagent

%Dependencies

%CheckIfOmiIsRunning
OMI_IS_RUNNING=1
if [ -f /var/opt/omi/run/omiserver.pid ]; then
    #  Check if omiserver is running with this pid.
    omi_pid=`cat /var/opt/omi/run/omiserver.pid`
    ps -aef | grep $omi_pid | grep omiserver 1> /dev/null 2> /dev/null
    if [ $? -ne 0 ]; then
	OMI_IS_RUNNING=0
    fi
else
    OMI_IS_RUNNING=0
fi

%Postinstall_10
WriteInstallInfo() {
    date +%Y-%m-%dT%T.0Z > /etc/opt/microsoft/omsagent/conf/installinfo.txt
    echo ${{VERSION}}-${{RELEASE}} >> /etc/opt/microsoft/omsagent/conf/installinfo.txt
}
WriteInstallInfo

%Postuninstall_10
# Calling sequence for RPM pre/post scripts, during upgrade, is as follows:
#   1. Run the %pre section of the RPM being installed.
#   2. Install the files that the RPM provides.
#   3. Run the %post section of the RPM.
#   4. Run the %preun of the old package.
#   5. Delete any old files not overwritten by the newer version.
#      (This step deletes files that the new package does not require.)
#   6. Run the %postun hook of the old package.
#
# Thus, if we're an upgrade, skip all of this cleanup
if ${{PERFORMING_UPGRADE_NOT}}; then 
   # Clean up installinfo.txt file (registered as "conf" file to pass rpmcheck)
   rm -f /etc/opt/microsoft/omsagent/conf/installinfo.txt*
   rmdir /etc/opt/microsoft/omsagent/conf 2> /dev/null
   rmdir /etc/opt/microsoft/omsagent 2> /dev/null
   rmdir /etc/opt/microsoft 2> /dev/null
   rmdir /etc/opt 2> /dev/null
fi

%Preinstall_0
${{SHELL_HEADER}}
%Postinstall_0
${{SHELL_HEADER}}
%Preuninstall_0
${{SHELL_HEADER}}
%Postuninstall_0
${{SHELL_HEADER}}
